{"version":3,"file":"index.js","names":["addon","require","getAddonReleaseVersion","PIXELATE_KERNEL","greyscale","cb","bitmap","data","cppCallbackWrapper","err","throwError","call","brightness","opacity","opaque","fade","f","bind","contrast","posterize","multiplier","sepia","convolution","kernel","edgeHandling","EdgeHandling","EDGE_EXTEND","getWidth","getHeight","convolute","x","y","w","h","ensureInteger","pixelate","size","width","height","plugin","color","greyscaleAsync","wrapAsync","grayscale","grayscaleAsync","brightnessAsync","opacityAsync","opaqueAsync","fadeAsync","contrastAsync","posterizeAsync","sepiaAsync","convolutionAsync","convoluteAsync","pixelateAsync"],"sources":["../src/index.ts"],"sourcesContent":["import { throwError } from \"@jimp/utils\";\nimport color, { Color } from \"@jimp/plugin-color\";\nimport { ImageCallback } from \"@jimp/core\";\nimport {\n  ensureInteger,\n  getAddonReleaseVersion,\n  cppCallbackWrapper,\n  AsyncPlugin,\n  wrapAsync,\n  EdgeHandling,\n} from \"@jimp-native/utils-ts\";\n\nconst addon = require(`../build/${getAddonReleaseVersion()}/plugin-color-napi.node`);\n\ntype PartialAsyncColorPlugin = AsyncPlugin<\n  Pick<\n    Color,\n    | \"greyscale\"\n    | \"grayscale\"\n    | \"brightness\"\n    | \"opacity\"\n    | \"opaque\"\n    | \"fade\"\n    | \"contrast\"\n    | \"posterize\"\n    | \"sepia\"\n    | \"convolution\"\n    | \"convolute\"\n    | \"pixelate\"\n  >\n>;\n\ntype MixedPlugin = Color & PartialAsyncColorPlugin;\n\nconst PIXELATE_KERNEL = [\n  [1 / 16, 2 / 16, 1 / 16],\n  [2 / 16, 4 / 16, 2 / 16],\n  [1 / 16, 2 / 16, 1 / 16],\n];\n\nconst greyscale = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.greyscale(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst brightness = function (\n  brightness: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  try {\n    addon.brightness(\n      this.bitmap.data,\n      brightness,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst opacity = function (opacity: number, cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.opacity(this.bitmap.data, opacity, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst opaque = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.opaque(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst fade = function (f: number, cb?: ImageCallback<MixedPlugin>) {\n  return opacity.bind(this)(1 - f, cb);\n};\n\nconst contrast = function (contrast: number, cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.contrast(this.bitmap.data, contrast, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst posterize = function (\n  multiplier: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  try {\n    addon.posterize(this.bitmap.data, multiplier, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst sepia = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.sepia(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst convolution = function (\n  kernel: number[][],\n  edgeHandling:\n    | EdgeHandling\n    | ImageCallback<MixedPlugin> = EdgeHandling.EDGE_EXTEND,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof edgeHandling === \"function\") {\n    cb = edgeHandling;\n    edgeHandling = EdgeHandling.EDGE_EXTEND;\n  }\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      kernel,\n      edgeHandling,\n      0,\n      0,\n      this.getWidth(),\n      this.getHeight(),\n      1,\n      cppCallbackWrapper(this, cb)\n    );\n\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst convolute = function (\n  kernel: number[][],\n  x?: number | ImageCallback<MixedPlugin>,\n  y?: number,\n  w?: number,\n  h?: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof x === \"function\") {\n    cb = x;\n    x = 0;\n  }\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      kernel,\n      EdgeHandling.EDGE_EXTEND,\n      ensureInteger(x ?? 0),\n      ensureInteger(y ?? 0),\n      ensureInteger(w ?? this.getWidth()),\n      ensureInteger(h ?? this.getHeight()),\n      1,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst pixelate = function (\n  size: number,\n  x?: number | ImageCallback<MixedPlugin>,\n  y?: number,\n  w?: number,\n  h?: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof x === \"function\") {\n    cb = x;\n    x = null;\n    y = null;\n    w = null;\n    h = null;\n  }\n\n  x = x ?? 0;\n  y = y ?? 0;\n  w = w || this.bitmap.width - ensureInteger(x);\n  h = h || this.bitmap.height - ensureInteger(y);\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      PIXELATE_KERNEL,\n      EdgeHandling.EDGE_EXTEND,\n      ensureInteger(x),\n      ensureInteger(y),\n      ensureInteger(w),\n      ensureInteger(h),\n      size,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst plugin: () => PartialAsyncColorPlugin = () => ({\n  ...color(), // Merge with original implementation as our C++ coverage of color is not complete\n  greyscale,\n  greyscaleAsync: wrapAsync(greyscale),\n  grayscale: greyscale,\n  grayscaleAsync: wrapAsync(greyscale),\n  brightness,\n  brightnessAsync: wrapAsync(brightness),\n  opacity,\n  opacityAsync: wrapAsync(opacity),\n  opaque,\n  opaqueAsync: wrapAsync(opaque),\n  fade,\n  fadeAsync: wrapAsync(fade),\n  contrast,\n  contrastAsync: wrapAsync(contrast),\n  posterize,\n  posterizeAsync: wrapAsync(posterize),\n  sepia,\n  sepiaAsync: wrapAsync(sepia),\n  convolution,\n  convolutionAsync: wrapAsync(convolution),\n  convolute,\n  convoluteAsync: wrapAsync(convolute),\n  pixelate,\n  pixelateAsync: wrapAsync(pixelate),\n});\n\nexport default plugin;\n"],"mappings":"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"}