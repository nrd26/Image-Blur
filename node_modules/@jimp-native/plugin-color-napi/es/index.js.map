{"version":3,"file":"index.js","names":["throwError","color","ensureInteger","getAddonReleaseVersion","cppCallbackWrapper","wrapAsync","EdgeHandling","addon","require","PIXELATE_KERNEL","greyscale","cb","bitmap","data","err","call","brightness","opacity","opaque","fade","f","bind","contrast","posterize","multiplier","sepia","convolution","kernel","edgeHandling","EDGE_EXTEND","getWidth","getHeight","convolute","x","y","w","h","pixelate","size","width","height","plugin","greyscaleAsync","grayscale","grayscaleAsync","brightnessAsync","opacityAsync","opaqueAsync","fadeAsync","contrastAsync","posterizeAsync","sepiaAsync","convolutionAsync","convoluteAsync","pixelateAsync"],"sources":["../src/index.ts"],"sourcesContent":["import { throwError } from \"@jimp/utils\";\nimport color, { Color } from \"@jimp/plugin-color\";\nimport { ImageCallback } from \"@jimp/core\";\nimport {\n  ensureInteger,\n  getAddonReleaseVersion,\n  cppCallbackWrapper,\n  AsyncPlugin,\n  wrapAsync,\n  EdgeHandling,\n} from \"@jimp-native/utils-ts\";\n\nconst addon = require(`../build/${getAddonReleaseVersion()}/plugin-color-napi.node`);\n\ntype PartialAsyncColorPlugin = AsyncPlugin<\n  Pick<\n    Color,\n    | \"greyscale\"\n    | \"grayscale\"\n    | \"brightness\"\n    | \"opacity\"\n    | \"opaque\"\n    | \"fade\"\n    | \"contrast\"\n    | \"posterize\"\n    | \"sepia\"\n    | \"convolution\"\n    | \"convolute\"\n    | \"pixelate\"\n  >\n>;\n\ntype MixedPlugin = Color & PartialAsyncColorPlugin;\n\nconst PIXELATE_KERNEL = [\n  [1 / 16, 2 / 16, 1 / 16],\n  [2 / 16, 4 / 16, 2 / 16],\n  [1 / 16, 2 / 16, 1 / 16],\n];\n\nconst greyscale = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.greyscale(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst brightness = function (\n  brightness: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  try {\n    addon.brightness(\n      this.bitmap.data,\n      brightness,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst opacity = function (opacity: number, cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.opacity(this.bitmap.data, opacity, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst opaque = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.opaque(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst fade = function (f: number, cb?: ImageCallback<MixedPlugin>) {\n  return opacity.bind(this)(1 - f, cb);\n};\n\nconst contrast = function (contrast: number, cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.contrast(this.bitmap.data, contrast, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst posterize = function (\n  multiplier: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  try {\n    addon.posterize(this.bitmap.data, multiplier, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst sepia = function (cb?: ImageCallback<MixedPlugin>) {\n  try {\n    addon.sepia(this.bitmap.data, cppCallbackWrapper(this, cb));\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst convolution = function (\n  kernel: number[][],\n  edgeHandling:\n    | EdgeHandling\n    | ImageCallback<MixedPlugin> = EdgeHandling.EDGE_EXTEND,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof edgeHandling === \"function\") {\n    cb = edgeHandling;\n    edgeHandling = EdgeHandling.EDGE_EXTEND;\n  }\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      kernel,\n      edgeHandling,\n      0,\n      0,\n      this.getWidth(),\n      this.getHeight(),\n      1,\n      cppCallbackWrapper(this, cb)\n    );\n\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst convolute = function (\n  kernel: number[][],\n  x?: number | ImageCallback<MixedPlugin>,\n  y?: number,\n  w?: number,\n  h?: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof x === \"function\") {\n    cb = x;\n    x = 0;\n  }\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      kernel,\n      EdgeHandling.EDGE_EXTEND,\n      ensureInteger(x ?? 0),\n      ensureInteger(y ?? 0),\n      ensureInteger(w ?? this.getWidth()),\n      ensureInteger(h ?? this.getHeight()),\n      1,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst pixelate = function (\n  size: number,\n  x?: number | ImageCallback<MixedPlugin>,\n  y?: number,\n  w?: number,\n  h?: number,\n  cb?: ImageCallback<MixedPlugin>\n) {\n  if (typeof x === \"function\") {\n    cb = x;\n    x = null;\n    y = null;\n    w = null;\n    h = null;\n  }\n\n  x = x ?? 0;\n  y = y ?? 0;\n  w = w || this.bitmap.width - ensureInteger(x);\n  h = h || this.bitmap.height - ensureInteger(y);\n\n  try {\n    addon.convolution(\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      PIXELATE_KERNEL,\n      EdgeHandling.EDGE_EXTEND,\n      ensureInteger(x),\n      ensureInteger(y),\n      ensureInteger(w),\n      ensureInteger(h),\n      size,\n      cppCallbackWrapper(this, cb)\n    );\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst plugin: () => PartialAsyncColorPlugin = () => ({\n  ...color(), // Merge with original implementation as our C++ coverage of color is not complete\n  greyscale,\n  greyscaleAsync: wrapAsync(greyscale),\n  grayscale: greyscale,\n  grayscaleAsync: wrapAsync(greyscale),\n  brightness,\n  brightnessAsync: wrapAsync(brightness),\n  opacity,\n  opacityAsync: wrapAsync(opacity),\n  opaque,\n  opaqueAsync: wrapAsync(opaque),\n  fade,\n  fadeAsync: wrapAsync(fade),\n  contrast,\n  contrastAsync: wrapAsync(contrast),\n  posterize,\n  posterizeAsync: wrapAsync(posterize),\n  sepia,\n  sepiaAsync: wrapAsync(sepia),\n  convolution,\n  convolutionAsync: wrapAsync(convolution),\n  convolute,\n  convoluteAsync: wrapAsync(convolute),\n  pixelate,\n  pixelateAsync: wrapAsync(pixelate),\n});\n\nexport default plugin;\n"],"mappings":"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"}