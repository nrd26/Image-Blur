{"version":3,"file":"index.js","names":["addon","require","getAddonReleaseVersion","BLEND_MODE_MAP","FullJimp","BLEND_SOURCE_OVER","BLEND_DESTINATION_OVER","BLEND_MULTIPLY","BLEND_ADD","BLEND_SCREEN","BLEND_OVERLAY","BLEND_DARKEN","BLEND_LIGHTEN","BLEND_HARDLIGHT","BLEND_DIFFERENCE","BLEND_EXCLUSION","composite","sourceImage","x","y","options","cb","constructor","throwError","call","mode","opacitySource","opacityDest","opacity","bitmap","data","getWidth","getHeight","ensureInteger","cppCallbackWrapper","err","plugin","compositeAsync","wrapAsync"],"sources":["../src/index.ts"],"sourcesContent":["import { throwError } from \"@jimp/utils\";\nimport { Jimp, ImageCallback, Image, BlendMode } from \"@jimp/core\";\nimport {\n  ensureInteger,\n  getAddonReleaseVersion,\n  cppCallbackWrapper,\n  AsyncPlugin,\n  wrapAsync,\n} from \"@jimp-native/utils-ts\";\nimport FullJimp from \"jimp\";\n\ntype PluginComposite = Pick<Jimp, \"composite\">;\n\nconst addon = require(`../build/${getAddonReleaseVersion()}/plugin-composite-napi.node`);\n\nconst BLEND_MODE_MAP = {\n  [FullJimp.BLEND_SOURCE_OVER]: 0,\n  [FullJimp.BLEND_DESTINATION_OVER]: 1,\n  [FullJimp.BLEND_MULTIPLY]: 2,\n  [FullJimp.BLEND_ADD]: 3,\n  [FullJimp.BLEND_SCREEN]: 4,\n  [FullJimp.BLEND_OVERLAY]: 5,\n  [FullJimp.BLEND_DARKEN]: 6,\n  [FullJimp.BLEND_LIGHTEN]: 7,\n  [FullJimp.BLEND_HARDLIGHT]: 8,\n  [FullJimp.BLEND_DIFFERENCE]: 9,\n  [FullJimp.BLEND_EXCLUSION]: 10,\n} as const;\n\nconst composite = function (\n  sourceImage: Jimp,\n  x: number,\n  y: number,\n  options: Partial<BlendMode> = {},\n  cb?: ImageCallback<Jimp>\n) {\n  if (typeof options === \"function\") {\n    cb = options;\n    options = {};\n  }\n\n  if (!(sourceImage instanceof this.constructor)) {\n    return throwError.call(this, \"sourceImage must be a Jimp image\");\n  }\n\n  let { mode, opacitySource, opacityDest } = options;\n\n  if (\n    typeof opacitySource !== \"number\" ||\n    opacitySource < 0 ||\n    opacitySource > 1\n  ) {\n    opacitySource = 1.0;\n  }\n\n  if (typeof opacityDest !== \"number\" || opacityDest < 0 || opacityDest > 1) {\n    opacityDest = 1.0;\n  }\n\n  if (opacityDest !== 1.0) {\n    this.opacity(opacityDest);\n  }\n\n  if (!mode) {\n    mode = FullJimp.BLEND_SOURCE_OVER;\n  }\n\n  try {\n    addon.composite(\n      sourceImage.bitmap.data,\n      sourceImage.getWidth(),\n      sourceImage.getHeight(),\n      this.bitmap.data,\n      this.getWidth(),\n      this.getHeight(),\n      ensureInteger(x),\n      ensureInteger(y),\n      BLEND_MODE_MAP[mode] || BLEND_MODE_MAP[FullJimp.BLEND_SOURCE_OVER],\n      opacitySource ?? 1.0,\n      cppCallbackWrapper(this, cb)\n    );\n\n    return this;\n  } catch (err) {\n    return throwError.call(this, err, cb);\n  }\n};\n\nconst plugin: () => AsyncPlugin<PluginComposite> = () => ({\n  composite,\n  compositeAsync: wrapAsync(composite),\n});\n\nexport default plugin;\n"],"mappings":";;;;;;AAAA;AAEA;AAOA;AAA4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAI5B,IAAMA,KAAK,GAAGC,OAAO,oBAAa,IAAAC,+BAAsB,GAAE,iCAA8B;AAExF,IAAMC,cAAc,2DACjBC,gBAAQ,CAACC,iBAAiB,EAAG,CAAC,oCAC9BD,gBAAQ,CAACE,sBAAsB,EAAG,CAAC,oCACnCF,gBAAQ,CAACG,cAAc,EAAG,CAAC,oCAC3BH,gBAAQ,CAACI,SAAS,EAAG,CAAC,oCACtBJ,gBAAQ,CAACK,YAAY,EAAG,CAAC,oCACzBL,gBAAQ,CAACM,aAAa,EAAG,CAAC,oCAC1BN,gBAAQ,CAACO,YAAY,EAAG,CAAC,oCACzBP,gBAAQ,CAACQ,aAAa,EAAG,CAAC,oCAC1BR,gBAAQ,CAACS,eAAe,EAAG,CAAC,oCAC5BT,gBAAQ,CAACU,gBAAgB,EAAG,CAAC,oCAC7BV,gBAAQ,CAACW,eAAe,EAAG,EAAE,mBACtB;AAEV,IAAMC,SAAS,GAAG,SAAZA,SAAS,CACbC,WAAiB,EACjBC,CAAS,EACTC,CAAS,EAGT;EAAA,IAFAC,OAA2B,uEAAG,CAAC,CAAC;EAAA,IAChCC,EAAwB;EAExB,IAAI,OAAOD,OAAO,KAAK,UAAU,EAAE;IACjCC,EAAE,GAAGD,OAAO;IACZA,OAAO,GAAG,CAAC,CAAC;EACd;EAEA,IAAI,EAAEH,WAAW,YAAY,IAAI,CAACK,WAAW,CAAC,EAAE;IAC9C,OAAOC,iBAAU,CAACC,IAAI,CAAC,IAAI,EAAE,kCAAkC,CAAC;EAClE;EAEA,eAA2CJ,OAAO;IAA5CK,IAAI,YAAJA,IAAI;IAAEC,aAAa,YAAbA,aAAa;IAAEC,WAAW,YAAXA,WAAW;EAEtC,IACE,OAAOD,aAAa,KAAK,QAAQ,IACjCA,aAAa,GAAG,CAAC,IACjBA,aAAa,GAAG,CAAC,EACjB;IACAA,aAAa,GAAG,GAAG;EACrB;EAEA,IAAI,OAAOC,WAAW,KAAK,QAAQ,IAAIA,WAAW,GAAG,CAAC,IAAIA,WAAW,GAAG,CAAC,EAAE;IACzEA,WAAW,GAAG,GAAG;EACnB;EAEA,IAAIA,WAAW,KAAK,GAAG,EAAE;IACvB,IAAI,CAACC,OAAO,CAACD,WAAW,CAAC;EAC3B;EAEA,IAAI,CAACF,IAAI,EAAE;IACTA,IAAI,GAAGrB,gBAAQ,CAACC,iBAAiB;EACnC;EAEA,IAAI;IAAA;IACFL,KAAK,CAACgB,SAAS,CACbC,WAAW,CAACY,MAAM,CAACC,IAAI,EACvBb,WAAW,CAACc,QAAQ,EAAE,EACtBd,WAAW,CAACe,SAAS,EAAE,EACvB,IAAI,CAACH,MAAM,CAACC,IAAI,EAChB,IAAI,CAACC,QAAQ,EAAE,EACf,IAAI,CAACC,SAAS,EAAE,EAChB,IAAAC,sBAAa,EAACf,CAAC,CAAC,EAChB,IAAAe,sBAAa,EAACd,CAAC,CAAC,EAChBhB,cAAc,CAACsB,IAAI,CAAC,IAAItB,cAAc,CAACC,gBAAQ,CAACC,iBAAiB,CAAC,oBAClEqB,aAAa,2DAAI,GAAG,EACpB,IAAAQ,2BAAkB,EAAC,IAAI,EAAEb,EAAE,CAAC,CAC7B;IAED,OAAO,IAAI;EACb,CAAC,CAAC,OAAOc,GAAG,EAAE;IACZ,OAAOZ,iBAAU,CAACC,IAAI,CAAC,IAAI,EAAEW,GAAG,EAAEd,EAAE,CAAC;EACvC;AACF,CAAC;AAED,IAAMe,MAA0C,GAAG,SAA7CA,MAA0C;EAAA,OAAU;IACxDpB,SAAS,EAATA,SAAS;IACTqB,cAAc,EAAE,IAAAC,kBAAS,EAACtB,SAAS;EACrC,CAAC;AAAA,CAAC;AAAC,eAEYoB,MAAM;AAAA;AAAA"}